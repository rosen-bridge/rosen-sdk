# Rosen SDK: Cardano

This document states the chain-specific functions of Rosen SDK on the Cardano chain.

## Contents

- [Transaction Structure](#transaction-structure)
- [Implmentation Details](#implmentation-details)
  - [getBaseNetworkFee](#getbasenetworkfee)
  - [generateLockAuxiliaryData](#generatelockauxiliarydata)
  - [generateLockTransaction](#generatelocktransaction)

## Transaction Structure

The lock transaction on Cardano should contain two main components:

1. Metadata: The Rosen data for transfer is written on the transaction metadata field. The fields are:

   - `to`: _string_, the target blockchain
   - `bridgeFee`: _string_, the amount of bridge fee for this transfer
   - `networkFee`: _string_, the amount of network fee for this transfer
   - `toAddress`: _string_, the destination address in the target blockchain
   - `fromAddress`: _array of strings_, the address that is requesting the transfer

   The data is formed as a JSON and is written under the `0` key of the metadata JSON. An example ([transaction](https://cardanoscan.io/transaction/1945e7c0b005698b7fa6d0e5578f14193879b9d1962075857befd4a838dcd840?tab=metadata)):

   ```json
   {
     "0": {
       "to": "ergo",
       "bridgeFee": "80325000",
       "networkFee": "19213",
       "toAddress": "9hBEAVZ9MHLf7mwVrvP3nqptdqYVdYGu1byPH8XFzC7KDuzrb8W",
       "fromAddress": [
         "addr1q85fh9t2cn7j8g62te545uyayjtlc7cwl9df50dugpe78r5d9z85ctlucfs",
         "nmefqrehxuvjw6ws6pzc5rvwyjdl2g8us6pr89f"
       ]
     }
   }
   ```

2. Locked Assets: The amount of transfer should be sent to the lock address in a single UTxO. If the UTxO contains a supported token, the transaction is recognized as a token transfer, otherwise it is recognized as an ADA transfer.

Note that if metadata is malformed or the transferring asset is not supported on the target chain, the lock transaction is not valid and is considered a donation.

## Implmentation Details

Alongside two chain-specific functions of Rosen SDK, another function is also suggested for Cardano. The implementation details of each one are described here.

### `getBaseNetworkFee`

The network fee on Cardano is fixed and 3.4 ADA. Therefore this function returns 3400000 (Lovelace unit).

```ts
/**
 * calculates the network fee on Cardano in lovelace unit
 * @returns the base network fee
 */
export const getBaseNetworkFee = (): bigint => 3400000n;
```

### `generateLockAuxiliaryData`

As mentioned before, the Rosen data is written in the transaction metadata field. This function generates the metadata in the `AuxiliaryData` format of the `@emurgo/cardano-serialization-lib` and returns the hex representation of it. Although this function is not necessary, it facilitates the `generateLockTransaction` function and makes it more modular.

A version of this function is available at [`@rosen-bridge/ui` GitHub](https://github.com/rosen-bridge/ui/blob/1c0b08f5407e929f5680aa01a316e2dc88ef1408/apps/rosen/app/_networks/cardano/transaction/utils.ts#L81).

```ts
/**
 * generates metadata for lock transaction
 * @param toChain
 * @param toAddress
 * @param fromAddress
 * @param networkFee
 * @param bridgeFee
 * @returns hex representation of the auxiliary data
 */
export const generateLockAuxiliaryData: (
  toChain: string,
  toAddress: string,
  fromAddress: string,
  networkFee: string,
  bridgeFee: string
) => Promise<string>;
```

### `generateLockTransaction`

This function generates an unsigned lock transaction.

The `protocolParams` is required to pass to the transaction builder. The interface is:

```ts
export interface CardanoProtocolParams {
  min_fee_a: number;
  min_fee_b: number;
  pool_deposit: string;
  key_deposit: string;
  max_value_size: number;
  max_tx_size: number;
  coins_per_utxo_size: string;
}
```

The function should use only a portion of UTxOs that covers the required assets. It may need to fetch UTxOs page by page. To this purpose, an Iterator object of the UTxOs is passed to the function. UTxOs are in `CardanoUtxo` format, which is:

```ts
export interface CardanoAsset {
  policyId: string;
  assetName: string;
  quantity: bigint;
}

export interface CardanoUtxo {
  txId: string;
  index: number;
  address: string;
  value: bigint;
  assets: Array<CardanoAsset>;
}
```

The `auxiliaryDataHex` contains Rosen data and is generated by the `generateLockAuxiliaryData` function.

A simple version of this function is available at [`@rosen-bridge/ui` GitHub](https://github.com/rosen-bridge/ui/blob/1c0b08f5407e929f5680aa01a316e2dc88ef1408/apps/rosen/app/_networks/cardano/transaction/generateTx.ts#L31).

```ts
/**
 * generates a lock transaction on Cardano
 * @param protocolParams The Cardano protocol params
 * @param utxoIterator an Iterator object that is used to fetch input utxos
 * @param lockAddress
 * @param changeAddress
 * @param policyIdHex transferring asset policy ID (empty string in case of ADA transfer)
 * @param assetNameHex transferring asset name in hex
 * @param amount
 * @param auxiliaryDataHex
 * @returns hex representation of the unsigned tx
 */
export const generateLockTransaction = async (
  protocolParams: CardanoProtocolParams,
  utxoIterator:
    | AsyncIterator<CardanoUtxo, undefined>
    | Iterator<CardanoUtxo, undefined>,
  lockAddress: string,
  changeAddress: string,
  policyIdHex: string,
  assetNameHex: string,
  amountString: string,
  auxiliaryDataHex: string,
): Promise<string>
```
